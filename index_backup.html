<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>시계 공부 – 초1 놀이앱 (모바일 고정)</title>
<style>
  :root{
    --bg:#0b0c10; --card:#101218; --ink:#e9ecff; --muted:#a7adcf;
    --line:#24283a; --brand:#7c4dff; --ok:#27ae60; --bad:#ff5a5a;
  }
  *{box-sizing:border-box}
  html,body{margin:0;background:var(--bg);color:var(--ink);
    font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans KR",sans-serif;
    overscroll-behavior:none;}
  .container{max-width:980px;margin:0 auto;padding:18px 14px}
  header{position:sticky;top:0;background:rgba(11,12,16,.7);backdrop-filter:blur(8px);
    border-bottom:1px solid var(--line);z-index:10}
  .bar{max-width:980px;margin:0 auto;display:flex;align-items:center;gap:10px;padding:12px 14px}
  .title{font-weight:700}
  .pill{border:1px solid var(--line);background:var(--card);border-radius:999px;padding:8px 12px}
  .row{display:flex;gap:14px;flex-wrap:wrap}
  .card{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:14px}
  .grow{flex:1 1 320px}
  .controls{display:flex;flex-wrap:wrap;gap:10px;align-items:center;margin:6px 0 10px}
  select,button,input{background:#0f0f14;border:1px solid var(--line);color:var(--ink);padding:10px 12px;border-radius:10px}
  button{cursor:pointer}
  button.primary{border-color:var(--brand)}
  .hint{color:var(--muted);font-size:.95rem}
  .big{font-size:1.25rem}
  .result{margin-top:8px;font-weight:700}
  .result.ok{color:var(--ok)} .result.bad{color:var(--bad)}
  .clock-wrap{display:flex;justify-content:center;align-items:center;padding:10px; -webkit-user-select:none; user-select:none; touch-action:none;}
  svg{max-width:420px;width:100%;height:auto; touch-action:none;}
  #clock, #minuteHand, #hourHand { touch-action:none; }
  /* 보이지 않는 히트영역(터치 집기 쉬움) */
  #minuteHand .hit, #hourHand .hit { fill: transparent; pointer-events: all; }

  /* 읽기 버튼 + 타이핑 */
  #btnReadTime{transition:transform .15s ease, box-shadow .15s ease}
  #btnReadTime:hover{transform:translateY(-1px); box-shadow:0 6px 18px rgba(124,77,255,.25)}
  #readText{margin-top:10px;text-align:center;font-size:1.05rem;min-height:1.6em}
  .typing::after{content:'▌';margin-left:2px;animation:caret 1s step-start infinite;opacity:.8}
  .typing.done::after{content:'';animation:none}
  @keyframes caret{50%{opacity:0}}

  /* 축하 토스트 */
  .toast{position:fixed;left:50%;top:18%;transform:translate(-50%,-20%) scale(.92);
    background:rgba(16,18,24,.85);border:1px solid var(--line);backdrop-filter:blur(8px);
    color:var(--ink);padding:14px 18px;border-radius:14px;box-shadow:0 10px 30px rgba(0,0,0,.35);
    font-weight:800;letter-spacing:.3px;z-index:10000;opacity:0}
  .toast.show{animation:pop .9s cubic-bezier(.2,.8,.2,1) forwards}
  @keyframes pop{0%{opacity:0;transform:translate(-50%,-10%) scale(.92)}45%{opacity:1;transform:translate(-50%,0) scale(1.02)}100%{opacity:1;transform:translate(-50%,0) scale(1)}}
  .celebrate{position:fixed;inset:0;pointer-events:none;z-index:9999}
</style>
</head>
<body>
<header>
  <div class="bar">
    <div class="title">🕒 시계 공부 – 초1 놀이앱</div>
    <div class="pill" style="margin-left:auto">🎯 목표: <strong id="targetLabel">—</strong></div>
  </div>
</header>

<div class="container">
  <div class="row">
    <section class="card grow">
      <h2 style="margin:6px 0 8px">아날로그 시계</h2>
      <div class="clock-wrap">
        <!-- 학습용 시계 -->
        <svg id="clock" viewBox="0 0 200 200" role="img" aria-label="학습용 시계">
          <circle cx="100" cy="100" r="94" fill="#0a0b10" stroke="#2c3150" stroke-width="2"/>
          <circle cx="100" cy="100" r="92" fill="#0f1119" stroke="#3a406b" stroke-width="1"/>
          <g id="ticks"></g>
          <!-- 분침 -->
          <g id="minuteHand" transform="rotate(0 100 100)" style="cursor:grab">
            <rect x="99" y="24" width="2" height="76" rx="2" ry="2" fill="#9ad0ff"/>
            <circle cx="100" cy="36" r="18" class="hit"></circle><!-- 히트영역 -->
            <circle cx="100" cy="100" r="6" fill="#9ad0ff"/>
          </g>
          <!-- 시침 -->
          <g id="hourHand" transform="rotate(0 100 100)" style="cursor:grab">
            <rect x="98" y="48" width="4" height="52" rx="2" ry="2" fill="#ffd480"/>
            <circle cx="100" cy="56" r="18" class="hit"></circle><!-- 히트영역 -->
            <circle cx="100" cy="100" r="6" fill="#ffd480"/>
          </g>
          <circle cx="100" cy="100" r="3" fill="#fff"/>
        </svg>
      </div>
      <div class="controls" style="justify-content:center; margin-top:10px">
        <button id="btnReadTime" class="primary">🗣️ 지금 시각 읽기</button>
      </div>
      <div id="readText" class="typing" aria-live="polite" aria-atomic="true"></div>
      <p class="hint" style="text-align:center">모바일에선 한 손가락으로 바늘을 끌어보세요.</p>
    </section>

    <section class="card grow">
      <h2 style="margin:6px 0 8px">게임 패널</h2>
      <div class="controls">
        <label>난이도
          <select id="difficulty">
            <option value="hour">정시(00분)</option>
            <option value="half">30분</option>
            <option value="ten">10분 단위</option>
            <option value="five" selected>5분 단위</option>
            <option value="one">1분 단위</option>
          </select>
        </label>
        <button id="newQ" class="primary">새 문제</button>
      </div>
      <div class="controls">
        <button id="checkSet">정답 확인</button>
        <button id="showAnswerSet">정답 보기</button>
        <span id="resultSet" class="result"></span>
      </div>
    </section>
  </div>
</div>

<canvas id="celebrateCanvas" class="celebrate"></canvas>
<div id="toast" class="toast">정답! 잘했어요 🎉</div>

<script>
/* ===== 공통 유틸 ===== */
const $ = s => document.querySelector(s);
const svg = $('#clock'), ticks = $('#ticks'), minHand = $('#minuteHand'), hourHand = $('#hourHand');
const state = { now:{h:3,m:0}, target:{h:3,m:0}, difficulty:'five' };
const pad2 = n => String(n).padStart(2,'0');
const label = (h,m)=>`${((h%12)+12)%12||12}시 ${pad2(m)}분`;

/* 눈금 */
(function build(){
  const cx=100,cy=100,rO=86,rI=80,rH=76;
  for(let i=0;i<60;i++){
    const a=(i/60)*2*Math.PI, isH=i%5===0;
    const r1=isH?rH:rI, x1=cx+r1*Math.sin(a), y1=cy-r1*Math.cos(a);
    const x2=cx+rO*Math.sin(a), y2=cy-rO*Math.cos(a);
    const ln=document.createElementNS('http://www.w3.org/2000/svg','line');
    ln.setAttribute('x1',x1); ln.setAttribute('y1',y1);
    ln.setAttribute('x2',x2); ln.setAttribute('y2',y2);
    ln.setAttribute('stroke',isH?'#9aa3d4':'#4a4f77'); ln.setAttribute('stroke-width',isH?'2.2':'1.1');
    ticks.appendChild(ln);
    if(isH){
      const num=(i/5)||12, rn=66, tx=cx+rn*Math.sin(a), ty=cy-rn*Math.cos(a)+4;
      const t=document.createElementNS('http://www.w3.org/2000/svg','text');
      t.setAttribute('x',tx); t.setAttribute('y',ty); t.setAttribute('fill','#cdd2ff');
      t.setAttribute('font-size','10'); t.setAttribute('text-anchor','middle'); t.textContent=num;
      ticks.appendChild(t);
    }
  }
})();

/* 렌더 */
function render(hh=state.now.h, mm=state.now.m){
  const m=mm, h=((hh%12)+12)%12;
  const ma=m*6, ha=h*30 + m*0.5;
  minHand.setAttribute('transform',`rotate(${ma} 100 100)`);
  hourHand.setAttribute('transform',`rotate(${ha} 100 100)`);
}

/* 문제 */
function randomTime(diff){
  let h=Math.floor(Math.random()*12), m=0;
  if(diff==='hour') m=0;
  else if(diff==='half') m=30;
  else if(diff==='ten') m=(Math.floor(Math.random()*6))*10;
  else if(diff==='five') m=(Math.floor(Math.random()*12))*5;
  else m=Math.floor(Math.random()*60);
  return {h,m};
}
function newQ(){
  state.target=randomTime(state.difficulty);
  $('#targetLabel').textContent=label(state.target.h,state.target.m);
  // 초기 위치는 다른 값으로
  const init=randomTime(state.difficulty);
  state.now={h:init.h,m:init.m};
  render();
}
$('#difficulty').addEventListener('change',e=>{state.difficulty=e.target.value; newQ();});
$('#newQ').addEventListener('click', newQ);
newQ();

/* === 좌표→각도 === */
function angleFromPoint(clientX, clientY){
  const rect = svg.getBoundingClientRect();
  const sx=(clientX-rect.left)*(200/rect.width);
  const sy=(clientY-rect.top)*(200/rect.height);
  let deg = Math.atan2(sx-100, -(sy-100))*180/Math.PI; if(deg<0)deg+=360; return deg;
}

/* === 모바일 드래그 안정화 (Pointer 우선 + Touch/Mouse 폴백) === */
let dragKind=null, activeId=null, tempM=null, tempH=null;
let startX=0,startY=0;

function getPoint(evt){
  if (evt.touches && evt.touches[0]) return {x:evt.touches[0].clientX, y:evt.touches[0].clientY, id:0};
  if (evt.changedTouches && evt.changedTouches[0]) return {x:evt.changedTouches[0].clientX, y:evt.changedTouches[0].clientY, id:0};
  return {x:evt.clientX, y:evt.clientY, id:evt.pointerId};
}

function startDrag(e, kind){
  e.preventDefault();
  const p=getPoint(e);
  dragKind=kind; activeId = ('pointerId' in e)? e.pointerId : 0;
  startX=p.x; startY=p.y;
  const target=(kind==='m')?minHand:hourHand;
  target.setPointerCapture?.(activeId);
}
function moveDrag(e){
  if(!dragKind) return;
  const p=getPoint(e);
  if(('pointerId' in e) && e.pointerId!==activeId) return;
  e.preventDefault();
  // 5px 데드존
  const dx=p.x-startX, dy=p.y-startY; if((dx*dx+dy*dy)<25) return;
  const deg=angleFromPoint(p.x,p.y);
  if(dragKind==='m'){ tempM = ((deg/6)%60+60)%60; }
  else{ tempH = ((deg/30)%12+12)%12; }
  render(tempH ?? state.now.h, tempM ?? state.now.m);
}
function endDrag(e){
  if(!dragKind) return;
  if(('pointerId' in e) && e.pointerId!==activeId) return;
  // 스냅: 손 뗄 때만
  if(dragKind==='m'){
    const m=tempM ?? state.now.m;
    const d=state.difficulty;
    state.now.m = (d==='hour')?0 : (d==='half')?30 :
                  (d==='ten')? Math.round(m/10)*10%60 :
                  (d==='five')?Math.round(m/5)*5%60 : Math.round(m)%60;
    tempM=null;
  }else{
    const h=tempH ?? state.now.h;
    state.now.h = Math.round(h)%12; tempH=null;
  }
  dragKind=null; activeId=null; render();
}

const supportsPointer = 'PointerEvent' in window;
if (supportsPointer){
  minHand.addEventListener('pointerdown', e=>startDrag(e,'m'), {passive:false});
  hourHand.addEventListener('pointerdown', e=>startDrag(e,'h'), {passive:false});
  window.addEventListener('pointermove', moveDrag, {passive:false});
  window.addEventListener('pointerup', endDrag, {passive:false});
  window.addEventListener('pointercancel', endDrag, {passive:false});
}else{
  // Touch/Mouse 폴백
  minHand.addEventListener('touchstart', e=>startDrag(e,'m'), {passive:false});
  hourHand.addEventListener('touchstart', e=>startDrag(e,'h'), {passive:false});
  window.addEventListener('touchmove', moveDrag, {passive:false});
  window.addEventListener('touchend', endDrag, {passive:false});
  minHand.addEventListener('mousedown', e=>startDrag(e,'m'));
  hourHand.addEventListener('mousedown', e=>startDrag(e,'h'));
  window.addEventListener('mousemove', moveDrag);
  window.addEventListener('mouseup', endDrag);
}

/* === 정답 체크 + 축하 === */
function celebrate(msg='정답! 잘했어요 🎉', dur=2800){
  const canvas = document.getElementById('celebrateCanvas');
}
const toastEl = document.getElementById('toast');
function showToast(text){
  toastEl.textContent=text; toastEl.classList.remove('show'); void toastEl.offsetWidth; toastEl.classList.add('show');
  setTimeout(()=>toastEl.classList.remove('show'), 2400);
}
// 간단 컨페티
(function(){
  const c=document.getElementById('celebrateCanvas'), ctx=c.getContext('2d');
  let W,H,parts=[],end=0,raf=null;
  function resize(){W=c.width=innerWidth*devicePixelRatio;H=c.height=innerHeight*devicePixelRatio;}
  window.addEventListener('resize',resize); resize();
  const Col=['#ffd480','#9ad0ff','#ff95c8','#7c4dff','#7ee5a5','#fff'];
  function R(a,b){return Math.random()*(b-a)+a}
  function spawn(n=120){
    parts=[];
    for(let i=0;i<n;i++)
      parts.push({x:R(0,W),y:R(-H*.2,-20),vx:R(-1,1),vy:R(1.2,3),g:R(.008,.02),s:R(6,14),r:R(0,6.28),vr:R(-.08,.08),c:Col[(Math.random()*Col.length)|0],a:R(.7,1)});
  }
  function tick(){
    ctx.clearRect(0,0,W,H);
    for(const p of parts){
      p.vy+=p.g; p.x+=p.vx; p.y+=p.vy; p.r+=p.vr;
      ctx.globalAlpha=p.a; ctx.fillStyle=p.c;
      ctx.save(); ctx.translate(p.x,p.y); ctx.rotate(p.r);
      ctx.fillRect(-p.s/2,-p.s/2,p.s,p.s);
      ctx.restore(); ctx.globalAlpha=1;
    }
    if(Date.now()<end) raf=requestAnimationFrame(tick);
    else { ctx.clearRect(0,0,W,H); cancelAnimationFrame(raf); }
  }
  window.triggerCelebration=(text='정답! 잘했어요 🎉', ms=2800)=>{
    showToast(text); spawn(); end=Date.now()+ms; tick();
  };
})();

$('#checkSet').addEventListener('click', ()=>{
  const ok = (state.now.h%12)===(state.target.h%12) && state.now.m===state.target.m;
  const res = $('#resultSet');
  if(ok){ res.textContent='정답! 잘했어요 🎉'; res.className='result ok'; triggerCelebration(); }
  else { res.textContent=`아쉬워요! 정답은 ${label(state.target.h,state.target.m)}`; res.className='result bad'; }
});
$('#showAnswerSet').addEventListener('click', ()=>{
  state.now={...state.target}; render();
});

/* === 읽어주기 + 타이핑 === */
let _timer=null;
function typeOut(el,text,speed=28){
  if(_timer){clearInterval(_timer);_timer=null;}
  el.classList.remove('done'); el.textContent='';
  let i=0; _timer=setInterval(()=>{ el.textContent=text.slice(0,i++); if(i>text.length){clearInterval(_timer);_timer=null; el.classList.add('done');}},speed);
}
function loadVoices(){return new Promise(r=>{const v=speechSynthesis.getVoices(); if(v&&v.length) r(v); else speechSynthesis.onvoiceschanged=()=>r(speechSynthesis.getVoices());});}
async function speak(){
  const out=$('#readText'); const h=((state.now.h%12)+12)%12||12, m=state.now.m;
  const txt=(m===0)?`지금은 ${h}시 정각이에요.`:`지금은 ${h}시 ${m}분이에요.`;
  typeOut(out, txt);
  try{
    const vs=await loadVoices(); const v=vs.find(v=>v.lang?.toLowerCase().startsWith('ko'))||vs[0];
    speechSynthesis.cancel(); const u=new SpeechSynthesisUtterance(txt);
    u.lang=v?.lang||'ko-KR'; u.voice=v||null; u.rate=.95; speechSynthesis.speak(u);
  }catch{}
}
$('#btnReadTime').addEventListener('click', speak, {passive:true});
</script>
</body>
</html>
